version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: linkmetur_postgres_prod
    environment:
      POSTGRES_DB: linkmeturdb
      POSTGRES_USER: linkmeturuser
      POSTGRES_PASSWORD: linkmeturpass123
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5432:5432"
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: linkmetur_redis_prod
    volumes:
      - redis_data_prod:/data
    ports:
      - "127.0.0.1:6379:6379"
    restart: unless-stopped

  app:
    image: linkmetur/app:latest
    container_name: linkmetur_app_prod
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://linkmeturuser:linkmeturpass123@postgres:5432/linkmeturdb
      - REDIS_URL=redis://redis:6379
      - NEXTAUTH_URL=https://linkmetur.com.br
      - NEXTAUTH_SECRET=supersecretkey12345
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

  nginx:
    image: nginx:1.24-alpine
    container_name: linkmetur_nginx_prod
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /root/nginx_ssl.conf:/etc/nginx/conf.d/default.conf
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - app
    restart: unless-stopped

  logrotate:
    image: alpine:latest
    container_name: linkmetur_logrotate
    volumes:
      - /var/log:/var/log
    command: >
      sh -c "
        apk add --no-cache logrotate &&
        echo '/var/log/*.log { daily rotate 7 compress delaycompress missingok notifempty }' > /etc/logrotate.d/logs &&
        while true; do logrotate /etc/logrotate.d/logs; sleep 86400; done
      "
    restart: unless-stopped

volumes:
  postgres_data_prod:
  redis_data_prod: